##### Intro
* 데이터베이스 주도 설계를 `의존성 역전`을 통해 영속성 계층을 애플리케이션 계층의 플러그인으로 만드는 방법을 살펴보자
##### 의존성 역전
* 애플리케이션 서비스 : 포트 인터페이스 호출
* 아웃고잉 포트 
  * 영속성 작업 수행 후 데이터베이스와 통신할 책임을 가진 영속성 어댑터 클래스에 의해 구현
  * 애플리케이션 서비스와 영속성 코드 사이의 간접적인 계층
  * 영속성 계층에 대한 코드 의존성을 없애기 위해 추가 -> 영속성 코드를 리팩터링하더라도 코어 코드를 변경하는 결과로 이어지지 않을 것
* 영속성 어댑터 : 아웃고잉 어댑터. 애플리케이션에 호출될 뿐, 직접 호출하지 않는다.
##### 영속성 어댑터의 책임
1. 입력을 받는다
   * 포트 인터페이스를 통해 입력을 받음
   * 입력 모델은 인터페이스가 지정한 도메인 엔티티나 특정 데이터베이스 연산 전용 객체가 될 것.
2. 입력을 데이터베이스 포맷으로 매핑한다.
   * 입력 모델을 데이터베이스를 쿼리하거나 변경하는 데 사용할 수 있는 포맷으로 매핑  ex. jpa 엔티티 객체
3. 입력을 데이터베이스로 보낸다.
4. 데이터베이스 출력을 애플리케이션 포맷으로 매핑한다.
5. 출력을 반환한다.
* 핵심은 영속성 어댑터의 입력 모델이 어댑터 내부에 있는 것이 아니라 애플리케이션 코어에 있기 때문에 영속성 어댑터 내부를 변경하는 것이 코어에 영향을 미치지 않는다.
* 출력모델이 영속성 어댑터가 아니라 애플리케이션 코어에 위치하는 것이 중요.
##### 포트 인터페이스 나누기
* 서비스를 구현하면서 생기는 의문 : 데이터베이스 연산을 정의하고 있는 포트 인터페이스를 어떻게 나눌것인가
* 일반적인 방법 : 특정 엔티티가 필요로 하는 모든 데이터베이스 연산을 하나의 리포지토리 인터페이스에 넣는 것
  * 문제점 : 데이터베이스에 의존하는 서비스는 인터페이스에서 단 하나의 메서드만 사용하더라도 하나의 '넓은'포트 인터페이스에 의존성을 갖게 됨. -> 불필요한 의존성이 생김
  * 로버트 C. 마틴 : "필요없는 화물을 운반하는 무언가에 의존하고 있으면 예상하지 못했던 문제가 생길 수 있다."
* 인터페이스 분리 원칙(ISP) : 클라이언트가 오로지 자신이 필요로 하는 메서드만 알면 되도록 넓은 인터페이스를 특화된 인터페이스로 분리해야 한다고 설명 -> 분리의 필요성
  * 원칙을 적용하면
    * 불필요한 의존성을 제거하고 기존 의존성을 눈에 더 잘 띄게 만들 수 있다.
    * 매우 좁은 포트를 만드는 것은 코딩을 플러그 앤드 플레이 경험으로 만든다. (재설정하거나 조정하는 과정 없이 연결하는 즉시 완벽하게 작동하는 방식) 
    * 서비스 코드를 짤 때 필요한 포트에 그저 꽂기만 하면 된다.
##### 영속성 어댑터 나누기
* 여러개의 영속성 어댑터를 만들 수 있다. 
  * 구현 방식 : JPA, OR, 평범한 SQL
  * 애그리거트 기준 : AccountPersistenceAdapter, UserPersistenceAdapter 
    * 도메인 경계에 따라 자동으로 나뉘어짐
    * account 맥락의 서비스가 billing 맥략의 영속성 어댑터에 접근X
    * 어떤 맥락이 다른 맥락에 있는 무언가를 필요로 한다면 전용 인커밍 포트를 통해 접근해야 한다. Q. 예를들면? 
    
##### 스프링 데이터 JPA 예제

##### 데이터베이스 트랜잭션은 어떻게 해야 할까?
> 트랜잭션 경계는 어디에 위치시켜야 할까?
* 트랜잭션은 하나의 특정한 유스케이스에 대해서는 일어나는 모든 쓰기 작업에 걸쳐 있어야 한다. -> 롤백을 위해
* 영속성 어댑터는 트랜잭션을 열고 닫을지 결정할 수 없다 -> 영속성 어댑터 호출을 관장하는 서비스에 위임해야
1. @transactional 애너테이션을 애플리케이션 서비스 클래스에 붙여서 스프링이 모든 public 메서드를 트랜잭션으로 감싸게 하는 방법
2. AspectJ 도구 이용하여 관점 지향 프로그래밍으로 트랜잭션 경계를 코드에 위빙 하는 방법
   * 위빙 : AOP에서 일반적으로 사용하는 용어, 런타임이나 컴파일 타임에 관점을 코드에 연결하는 것
##### 유지보수 가능한 소프트웨어를 만드는 데 어떻게 도움이 될까?
* 영속성 어댑터를 만들면 도메인 코드가 영속성과 관련된 것들으로부터 분리되어 풍부한 도메인 모델을 만들 수 있다.
* 좁은 포트 인터페이스를 사용하면 포트마다 다른 방식으로 구현할 수 있는 유연함이 생긴다.